#!/bin/bash

# Function to run the Maven command inside the Docker container
# @param $# Additional arguments to be passed to the Maven command
# @return 0 if the command runs successfully, non-zero exit code otherwise
mrun() {
    # Initialize an array to hold directive names
    local directives=()
    local non_directives=()
    local interactive_flag="-it"  # Default to interactive mode

    # Loop through all provided arguments
    for arg in "$@"; do
        if [[ $arg == --* ]]; then
            # If the argument is a directive, add it to the array
            directives+=("$arg")
        else
            non_directives+=("$arg")
        fi
    done

    # Shift the processed arguments
    set -- "${non_directives[@]}" # Retain only the non-directive arguments for the command

    output=""
    exit_code=1
    # Check for the --noit directive
    if [[ " ${directives[@]} " =~ " --noit " ]]; then
        # Capture the output of the Docker command without TTY
        set -x
        output=$(docker exec maven mvn -f EventManagementApp/EventManApp "$@")
        set +x
        exit_code=$?
    else
        set -x
        docker exec -it maven mvn -f EventManagementApp/EventManApp "$@"
        set +x
        exit_code=$?
    fi

    # Print the output if the exit code is not 0
    if [ $exit_code -ne 0 ]; then
        echo "Error running Docker command:"
        echo "$output"
    elif [[ ! " ${directives[@]} " =~ " --quiet " ]]; then
        # If --quiet is not present, print the output anyway
        echo "$output"
    fi

    # Return the exit status
    return $exit_code
}

# Function to run the Maven command using mrun
# @param $# Additional arguments to be passed to the mrun function
# @return The exit status of the mrun function
mvn() {
    mrun "$@"
    return $?
}

# Function to check the status of the Maven Docker container
# @param $# Additional arguments (not used in this function)
# @return 0 if the container is running, non-zero exit code otherwise
mstatus() {
    # Initialize an array to hold directive names
    local directives=()
    local non_directives=()
    local interactive_flag="-it"  # Default to interactive mode

    # Loop through all provided arguments
    for arg in "$@"; do
        if [[ $arg == --* ]]; then
            # If the argument is a directive, add it to the array
            directives+=("$arg")
        else
            non_directives+=("$arg")
        fi
    done

    # Shift the processed arguments
    set -- "${non_directives[@]}" # Retain only the non-directive arguments for the command

    exit_code=1
    # Check if Docker is running and if the container exists
    if [ "$(docker ps -q -f name=maven)" ]; then
        echo "Docker container 'maven' is available."
        # Capture the output of the Docker command
        output=$(docker inspect --format='{{.Name}} - {{.State.Status}}' maven)
        exit_code=$?
    elif [[ ! " ${directives[@]} " =~ " --quiet " ]]; then
        # If --quiet is not present, print the output anyway
        echo "$output"
    fi

    # Print the output if the exit code is not 0
    if [ $exit_code -ne 0 ]; then
        echo "Docker container 'maven' is not running or does not exist."
        echo "Error running Docker command:"
        echo "$output"
    fi

    # Return the exit status
    return $exit_code
}

# Check the status of the Maven Docker container
mstatus
mavenStatus=$?

# Main code block
if [ "$0" = "./mavenrun" ] || [ "$0" = "mavenrun" ]; then
    if [ "$mavenStatus" -eq 0 ]; then
        # Run the mrun function with any additional arguments passed to the script
        mrun "$@"
        commandStatus=$?  # Capture the exit status of mrun
        exit "$commandStatus"  # Exit with the status of mrun
    else
        exit 1
    fi
fi
