# File pipeline-on-develop.yml
name: pipeline-on-develop

on:
  push:
    branches:
      - develop  # Commit changes here will trigger the action

permissions:
  contents: write

jobs:
  do-merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Do merge
        run: echo "merge work"

  call_generate:
    needs: do-merge
    uses: ./.github/workflows/generate-deck.yml
    with:
      commit_sha: ${{ github.sha }}

  call_automerge:
    needs: call_generate
    uses: ./.github/workflows/auto-merge-changes.yml
    with:
      commit_sha: ${{ github.sha }}

  check_directives:
    needs: call_automerge
    runs-on: ubuntu-latest
    outputs:
      merge_action_triggered: ${{ steps.check.outputs.result }}  # Define output
    steps:
      - name: Checkout specific branch
        uses: actions/checkout@v2
        with:
          ref: develop  # Explicitly specify the branch

      - name: List files for debugging
        run: ls -R .github/scripts

      - name: Check commit directives
        id: check  # Set an ID for this step
        run: |
          chmod +x .github/scripts/git-extract-directives.sh
          directives=$(.github/scripts/git-extract-directives.sh "${{ github.sha }}")
          result=$?
          chmod -x .github/scripts/git-extract-directives.sh

          echo "Extracted directives: $directives"
          echo "Result code: $result"

          if [ "$result" -eq 0 ] && [[ "$directives" == *"--merge"* ]]; then
            echo "Directive found: --merge"
            echo "result=true" >> $GITHUB_ENV  # Set the environment variable
            echo "::set-output name=result::true"  # Output for next job
          else
            echo "No valid directives found."
            echo "result=false" >> $GITHUB_ENV  # Set to false
            echo "::set-output name=result::false"  # Output for next job
          fi

      - name: Debug output for merge_action_triggered
        run: |
          echo "Setting merge_action_triggered to: ${{ steps.check.outputs.result }}"
  call_mainmerge:
    needs: check_directives  
    runs-on: ubuntu-latest  # Ensure a consistent environment
    steps:
      - name: Debug output of merge_action_triggered
        run: |
          echo "merge_action_triggered: ${{ needs.check_directives.outputs.merge_action_triggered }}"
        
      - name: Proceed to main merge if directive is found
        if: ${{ needs.check_directives.outputs.merge_action_triggered == 'true' }}
        run: echo "Proceeding to main merge..."
      
      - name: Execute main merge workflow
        if: ${{ needs.check_directives.outputs.merge_action_triggered == 'true' }}
        uses: ./.github/workflows/main-merge-changes.yml
        with:
          commit_sha: ${{ github.sha }}

