on:
  push:
    branches:
      - develop

jobs:
  check-and-merge:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Set up Bash
      - name: Set up Bash
        shell: bash
        run: echo "Bash is set up"

      # Step 3: Read the list of files and folders
      - name: Read files list
        id: readfiles
        run: |
          set -x
          SOURCE_BRANCH=develop
          TARGET_BRANCH=main
          if [[ -f .gitautomarge ]]; then
            FILES_TO_CHECK=$(grep -v '^\s*#' .gitautomarge | awk '{print $1}' | tr '\n' ' ' | xargs)
            if [[ -z "$FILES_TO_CHECK" ]]; then
              echo "No valid files to check!"
              exit 1
            fi
            echo "FILES_TO_CHECK=${FILES_TO_CHECK}" >> $GITHUB_ENV
          else
            echo "File list not found!"
            exit 1
          fi
      # Step 4: Check for changes in the specified files
      - name: Auto-check for changes
        id: check-changes
        run: |
          set -x
          # Fetch the latest state of both branches
          git fetch origin main
          git fetch origin develop

          # Get the list of changed files between the develop branch and the main branch
          CHANGED_FILES=$(git diff --name-only origin/main..origin/develop)

          # Check if any files in FILES_TO_CHECK have changed
          for file in ${FILES_TO_CHECK}; do
            if echo "$CHANGED_FILES" | grep -q "$file"; then
              echo "File changed: $file"
              echo "file_changed=true" >> $GITHUB_ENV
              break
            fi
          done
      # Step 5: Copy and push changes if any file was changed
      - name: Auto-copy and Push Changes
        if: env.file_changed == 'true'
        run: |
          set -x
          git checkout ${TARGET_BRANCH}
          for file in ${FILES_TO_CHECK}; do
            git checkout ${SOURCE_BRANCH} -- "$file"
          done
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-merge from ${SOURCE_BRANCH} to ${TARGET_BRANCH}"
          git push origin ${TARGET_BRANCH}
