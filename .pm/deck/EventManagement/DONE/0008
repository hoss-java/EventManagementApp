---
#...
# Git-deck card header
# OBS! DON'T REMOVE CARD HEADERS
#...
Title: Automate local and remote repos to run test automatically.
Tags: EventMan STEP2
Creator:
AssignedTo:
# Time tracker settings
tartAt:
EndAt:
---
The goal of this card is to add needed actions to GIHub workflow to run tests.

# DOD (definition of done):
GitHub workflows uses tests results to verify commits.

# TODO:
- [x] 1. Develop a simple local CI
- [x] 2. Find out how to run tests on GitHub side
- [x] 3. Find out how to check commit messages via workflow actions
- [x] 4. Implement test check to git hooks
- [x] 5. Implement test check to GitHUb Workflow
- [x] 6. Develop an automation to run test and push codes to main branch if test passed

# Reports:
* What it means with local CI here :
> * A simple Continuous Integration (CI) system integrates one or more tools to run tests on code, ensuring that all components function correctly.
> * Considering the above point, a tool can run tests either manually or automatically before pushing code to the repository.
> * The tool(s) report the results of running tests as logical outputs, such as 0 (true, passed) and 1 (false, failed). This format allows scripts, particularly local ones using Git and its hooks, to make informed decisions based on the test outcomes.
* So what it needs to do for the local part
> * Develop a simple tools to run test which is already done (`mavenrun`  script)
>> * `mavenrun` can be used both directly and via sourcing
>>> * Use as a script on cli
>>>> ```
>>>>#./mavenrun [--quiet] <maven-directives>
>>>># for example
>>>>./mavenrun test
>>>>./mavenrun --quiet test
>>>>./mavenrun clean test
>>>>./mavenrun compile
>>>>./mavenrun clean compile
>>>>./mavenrun package
>>>>./mavenrun exec:java
>>>>
>>>># exit code can be use of the result
>>>># 0 - Success
>>>># 1 - Failed
>>>> ```
>>> * Sourcing
>>>> ```
>>>> source mavenrun
>>>> 
>>>>#mrun [--quiet] <maven-directives>
>>>>#mstatus
>>>>
>>>>mstatus
>>>>
>>>>mrun test
>>>>mrun --quiet test
>>>>mrun clean test
>>>>mrun compile
>>>>mrun clean compile
>>>>mrun package
>>>>mrun exec:java
>>>>
>>>># exit code can be use of the result
>>>># 0 - Success
>>>># 1 - Failed
>>>> ```
> * Implement the script to git hooks
>> * It has also been implemented in Git hooks. The current `.git/hooks/pre-commit` script checks for a file named .commit-check in the root of the Git repository. If it finds the file, it will execute it and return an exit code to git. [pre-commit](https://github.com/hoss-java/git-hooks/blob/main/hooks/pre-commit)
>> * It means it needs only to call `mrun` in the `.commit-check` and return the exit code of `mrun` to git, a simple `.commit-check`
>>>```
>>>#: Pre-commit checker to use within git hook `pre-commit`
>>>#:
>>>#: File : .commit-check
>>>#: Description : The code here run to check committed files
>>>#:      before committing.
>>>#:      The code set exitCode=1 if the check result is false
>>>#:      Otherwise exitCode=0 (or doing nothing).
>>>#: OBS! : This file should be located in the root of the repo.
>>>#
>>>#
>>># Local variables:
>>>#  exitcode
>>>#  GIT_ROOT
>>>#---------------------------------------
>>>    bash -c "source $GIT_ROOT/mavenrun && mrun --quiet test" \
>>>    && exitcode=0
>>>else
>>>    exitcode=1
>>>fi
>>>```
>> * It also needs to make it possible to skip checks when it needs.
>>> * To achieve this, the `git-hooks` have been updated to include improved scripts that are more generic. Most of the scripts added/developed to/for the `git-hooks` are designed to work specifically with `commit-msg`. However, these helper scripts are now more versatile, allowing them to be used with other hooks such as `pre-commit` [git-hooks](https://github.com/hoss-java/git-hooks/tree/main).
>>> * A new setting (`commitCheckFlag=true`) was added to `.gitdefault` to defain default status to run tests.
>>> * It's also possible now skip running test by using a directive (`--notest`) via git message
>>>>```
>>>># for example 
>>>>git commit -m "[B001-C0009] Improve git hooks." -m "--notest"
>>>>```
>>> * By default if no file named `.commit-check` is found in the root of the repository, running tests is skipped regardless what the default setting is or which directive is used.

## Find out how to run tests on GitHub side
* It seems packages such as JDK and maven can be not installed in the way that is used to Ubuntu packages.
* It can be install through reuse the packages that already available and installed (I don't how!).
* However here the way that worked
>```
>    steps:
>      # Step 1: Checkout the repository
>      - name: Checkout repo (fetch all)
>        uses: actions/checkout@v5
>        with:
>          fetch-depth: 0
>
>      # Step 2: Set up Java
>      - name: Set up JDK 17
>        uses: actions/setup-java@v4
>        with:
>          java-version: '17'
>          distribution: 'temurin'
>          cache: maven
>```

* Running tests and merge codes from the `develop`  branch to the `main` has been not set up to run after each commit.
> * A new section has been added to the pipeline to check for directives included in the commit message. If the message contains `--merge` (not on the first line, but added on the second line or later), then the tests and merge action will be triggered.
>>```
>># for example 
>>git commit -m "[B001-C0008] Automate running tests - github action" -m "--merge"
>>```

* Now both local and remote provide running tests to check code integration. In the local case , tests is run before commit changes via `git commit -m ...`  or `git commit --amend`
* Running tests in local cases can be skipped by passing the directive `--notest` via git commit message, or by changing default settings via file `.gitdefault` stored on the repository root
* On the remote case, the tests are run if a commit message provides the directiv `--merge`. In the remote case it all tests are passed, files listed on the file `.gitmain` stored on the the repository root are merged from `develop` to `main` also.
